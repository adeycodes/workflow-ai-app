<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Templates - WorkflowAI Admin</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="container admin-navbar">
            <a href="/admin/" class="admin-navbar-brand">
                <i class="fas fa-crown"></i>
                WorkflowAI Admin
            </a>
            <ul class="admin-nav-links">
                <li><a href="/admin/"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="/admin/templates.html"><i class="fas fa-th-large"></i> Templates</a></li>
                <li><a href="/dashboard.html"><i class="fas fa-arrow-left"></i> Back to App</a></li>
                <li><a href="#" id="logoutBtn" class="btn btn-outline"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
    </header>

    <!-- Admin Content -->
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="sidebar-header">
                <h3>Administration</h3>
            </div>
            <ul>
                <li><a href="/admin/"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="/admin/templates.html" class="active"><i class="fas fa-th-large"></i> Manage Templates</a></li>
                <li><a href="#"><i class="fas fa-users"></i> Manage Users</a></li>
                <li><a href="#"><i class="fas fa-cog"></i> System Settings</a></li>
                <li><a href="#"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="#"><i class="fas fa-bell"></i> Notifications</a></li>
                <li><a href="#"><i class="fas fa-database"></i> Database</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="admin-content">
            <div class="admin-content-header">
                <h1>Manage Templates</h1>
                <button class="admin-btn admin-btn-primary" id="addTemplateBtn">
                    <i class="fas fa-plus"></i> Add New Template
                </button>
            </div>
            
            <div id="alert" class="admin-alert" style="display: none;"></div>
            
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>All Templates</h2>
                    <div class="d-flex gap-md">
                        <select class="admin-form-control" style="width: 150px;">
                            <option>All Categories</option>
                            <option>Sales</option>
                            <option>Marketing</option>
                            <option>Customer Service</option>
                            <option>Finance</option>
                            <option>Operations</option>
                        </select>
                        <button class="admin-btn admin-btn-outline">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>n8n ID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="templatesTableBody">
                        <tr>
                            <td colspan="5" class="text-center">
                                <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--admin-primary);"></i>
                                <p class="mt-md mb-0">Loading templates...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Template Modal -->
    <div id="templateModal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2 id="modalTitle">Add New Template</h2>
                <button class="admin-modal-close" id="closeModalBtn">&times;</button>
            </div>
            <form id="templateForm">
                <input type="hidden" id="templateId">
                <div class="admin-modal-body">
                    <div class="admin-form-group">
                        <label for="templateName">Template Name</label>
                        <input type="text" id="templateName" class="admin-form-control" placeholder="Enter template name" required>
                    </div>
                    <div class="admin-form-group">
                        <label for="templateDescription">Description</label>
                        <textarea id="templateDescription" class="admin-form-control" placeholder="Enter template description" rows="3" required></textarea>
                    </div>
                    <div class="admin-form-group">
                        <label for="templateCategory">Category</label>
                        <select id="templateCategory" class="admin-form-control" required>
                            <option value="">Select Category</option>
                            <option value="Sales">Sales</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Customer Service">Customer Service</option>
                            <option value="Finance">Finance</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                    <div class="admin-form-group">
                        <label for="n8nWorkflowId">n8n Workflow ID</label>
                        <input type="text" id="n8nWorkflowId" class="admin-form-control" placeholder="Enter n8n workflow ID" required>
                    </div>
                </div>
                <div class="admin-modal-footer">
                    <button type="button" class="admin-btn admin-btn-outline" id="cancelModalBtn">Cancel</button>
                    <button type="submit" class="admin-btn admin-btn-primary" id="saveTemplateBtn">
                        <span id="saveTemplateText">Save Template</span>
                        <span id="saveTemplateSpinner" class="spinner" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="../config.js"></script>
    <script>
        // Check if user is logged in and is admin
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login.html';
        }
        
        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('access_token');
            window.location.href = '/login.html';
        });
        
        // Modal functionality
        const modal = document.getElementById('templateModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        
        document.getElementById('addTemplateBtn').addEventListener('click', () => {
            showTemplateModal();
        });
        
        closeModalBtn.addEventListener('click', hideTemplateModal);
        cancelModalBtn.addEventListener('click', hideTemplateModal);
        
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                hideTemplateModal();
            }
        });
        
        // Show modal for adding/editing template
        function showTemplateModal(template = null) {
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('templateForm');
            
            if (template) {
                // Edit mode
                title.textContent = 'Edit Template';
                document.getElementById('templateId').value = template.id;
                document.getElementById('templateName').value = template.name;
                document.getElementById('templateDescription').value = template.description;
                document.getElementById('templateCategory').value = template.category;
                document.getElementById('n8nWorkflowId').value = template.n8n_workflow_id;
            } else {
                // Add mode
                title.textContent = 'Add New Template';
                form.reset();
                document.getElementById('templateId').value = '';
            }
            
            modal.style.display = 'flex';
        }
        
        // Hide modal
        function hideTemplateModal() {
            modal.style.display = 'none';
        }
        
        // Load templates
        async function loadTemplates() {
            try {
                const response = await fetch(CONFIG.API_BASE_URL + '/api/templates/');
                
                if (response.ok) {
                    const templates = await response.json();
                    const tbody = document.getElementById('templatesTableBody');
                    tbody.innerHTML = '';
                    
                    if (templates.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center">
                                    <i class="fas fa-th-large" style="font-size: 2rem; color: #cbd5e1;"></i>
                                    <p class="mt-md mb-0">No templates found</p>
                                    <p class="mb-0" style="color: #64748b;">Create your first template to get started</p>
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    templates.forEach(template => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${template.name}</td>
                            <td>${template.description}</td>
                            <td><span class="badge" style="background-color: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem;">${template.category}</span></td>
                            <td>${template.n8n_workflow_id}</td>
                            <td class="admin-table-actions">
                                <button class="admin-btn admin-btn-outline admin-btn-sm" onclick="editTemplate(${template.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteTemplate(${template.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    throw new Error('Failed to load templates');
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                const tbody = document.getElementById('templatesTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--admin-danger);"></i>
                            <p class="mt-md mb-0">Failed to load templates</p>
                            <button class="admin-btn admin-btn-outline mt-md" onclick="loadTemplates()">
                                <i class="fas fa-sync"></i> Retry
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Edit template
        async function editTemplate(templateId) {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/templates/${templateId}`);
                
                if (response.ok) {
                    const template = await response.json();
                    showTemplateModal(template);
                } else {
                    throw new Error('Failed to load template');
                }
            } catch (error) {
                console.error('Error loading template:', error);
                showAlert('Failed to load template. Please try again.', 'danger');
            }
        }
        
        // Delete template
        async function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/templates/${templateId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    loadTemplates(); // Reload templates
                    showAlert('Template deleted successfully.', 'success');
                } else {
                    throw new Error('Failed to delete template');
                }
            } catch (error) {
                console.error('Error deleting template:', error);
                showAlert('Failed to delete template. Please try again.', 'danger');
            }
        }
        
        // Handle form submission
        document.getElementById('templateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const templateId = document.getElementById('templateId').value;
            const name = document.getElementById('templateName').value;
            const description = document.getElementById('templateDescription').value;
            const category = document.getElementById('templateCategory').value;
            const n8nWorkflowId = document.getElementById('n8nWorkflowId').value;
            
            const saveBtn = document.getElementById('saveTemplateBtn');
            const saveText = document.getElementById('saveTemplateText');
            const saveSpinner = document.getElementById('saveTemplateSpinner');
            
            // Show loading state
            saveText.style.display = 'none';
            saveSpinner.style.display = 'inline-block';
            saveBtn.disabled = true;
            
            const templateData = {
                name: name,
                description: description,
                category: category,
                n8n_workflow_id: n8nWorkflowId
            };
            
            try {
                let response;
                
                if (templateId) {
                    // Update existing template
                    response = await fetch(`${CONFIG.API_BASE_URL}/api/templates/${templateId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(templateData)
                    });
                } else {
                    // Create new template
                    response = await fetch(`${CONFIG.API_BASE_URL}/api/templates/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(templateData)
                    });
                }
                
                if (response.ok) {
                    hideTemplateModal();
                    loadTemplates(); // Reload templates
                    showAlert(templateId ? 'Template updated successfully.' : 'Template added successfully.', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(templateId ? 'Failed to update template' : 'Failed to add template');
                }
            } catch (error) {
                console.error('Error saving template:', error);
                showAlert(templateId ? 'Failed to update template. Please try again.' : 'Failed to add template. Please try again.', 'danger');
            } finally {
                // Restore button state
                saveText.style.display = 'inline';
                saveSpinner.style.display = 'none';
                saveBtn.disabled = false;
            }
        });
        
        // Show alert
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `admin-alert admin-alert-${type}`;
            alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
            alert.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadTemplates();
        });
    </script>
</body>
</html>